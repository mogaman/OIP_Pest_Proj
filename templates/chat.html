{% extends "base.html" %}

{% block title %}AI Chat - OrganicGuard AI{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="hero-section mb-4">
                <div class="container">
                    <h1 class="display-5 fw-bold text-center">
                        <i class="fas fa-robot me-3"></i>AI Expert Consultation
                    </h1>
                    <p class="lead text-center">
                        Get personalized advice from our AI agricultural expert on organic pest management, IPM strategies, and farming best practices.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="feature-card">
                <!-- Chat Header -->
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="feature-icon me-3" style="width: 50px; height: 50px;">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 class="h4 mb-0">OrganicGuard AI Expert</h3>
                            <small class="text-muted">Specialized in organic pest management</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">
                            <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>Online
                        </span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
                            <i class="fas fa-trash me-1"></i>Clear
                        </button>
                    </div>
                </div>

                <!-- Chat Messages Container -->
                <div class="chat-container" id="chatContainer">
                    <!-- Welcome Message -->
                    <div class="chat-message ai-message">
                        <div class="d-flex align-items-start">
                            <div class="feature-icon me-3" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong class="d-block mb-1">OrganicGuard AI</strong>
                                <p class="mb-0">
                                    Hello! I'm your AI agricultural expert specializing in organic pest management. 
                                    I can help you with:
                                </p>
                                <ul class="mt-2 mb-0">
                                    <li>Pest identification and treatment recommendations</li>
                                    <li>Organic farming best practices</li>
                                    <li>IPM (Integrated Pest Management) strategies</li>
                                    <li>Cost estimates and application timing</li>
                                    <li>Prevention and monitoring techniques</li>
                                </ul>
                                <p class="mt-2 mb-0">
                                    <strong>How can I assist you with your organic farming needs today?</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Suggestion Buttons -->
                <div class="mb-3">
                    <h6 class="mb-2">Quick Questions:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('How do I control aphids organically?')">
                            <i class="fas fa-bug me-1"></i>Control Aphids
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('What are the best organic treatments for beetles?')">
                            <i class="fas fa-shield-alt me-1"></i>Beetle Control
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('How much do organic treatments cost?')">
                            <i class="fas fa-dollar-sign me-1"></i>Treatment Costs
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('What are IPM prevention strategies?')">
                            <i class="fas fa-shield-alt me-1"></i>Prevention
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMessage('When is the best time to apply treatments?')">
                            <i class="fas fa-clock me-1"></i>Timing
                        </button>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="d-flex gap-2">
                    <div class="flex-grow-1">
                        <input type="text" 
                               id="messageInput" 
                               class="form-control" 
                               placeholder="Ask about organic pest management, treatments, costs, timing..."
                               onkeypress="handleKeyPress(event)">
                    </div>
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

                <!-- Upload Image Option -->
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        ðŸ’¡ Tip: For pest identification, 
                        <a href="{{ url_for('analyze') }}" class="text-decoration-none">upload an image</a> 
                        for AI visual analysis
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Information Cards -->
    <div class="row mt-5">
        <div class="col-md-4">
            <div class="feature-card text-center h-100">
                <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                <h5>Expert Knowledge</h5>
                <p class="text-muted">AI trained on agricultural research and organic farming best practices</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="feature-card text-center h-100">
                <i class="fas fa-clock fa-3x text-success mb-3"></i>
                <h5>24/7 Availability</h5>
                <p class="text-muted">Get instant answers anytime, even when extension services are closed</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="feature-card text-center h-100">
                <i class="fas fa-certificate fa-3x text-warning mb-3"></i>
                <h5>Organic Focused</h5>
                <p class="text-muted">All recommendations comply with organic certification standards</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let messageCount = 0;

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (message === '') return;

        // Add user message to chat
        addMessageToChat('user', message);
        messageInput.value = '';

        // Show typing indicator
        showTypingIndicator();

        // Send message to API
        fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            // Remove typing indicator
            removeTypingIndicator();
            
            // Add AI response to chat
            if (data.response) {
                addMessageToChat('ai', data.response);
            } else if (data.error) {
                addMessageToChat('ai', 'Sorry, I encountered an error. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            removeTypingIndicator();
            addMessageToChat('ai', 'Sorry, I\'m having trouble connecting right now. Please try again.');
        });
    }

    function sendQuickMessage(message) {
        document.getElementById('messageInput').value = message;
        sendMessage();
    }

    function addMessageToChat(type, message) {
        const chatContainer = document.getElementById('chatContainer');
        messageCount++;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}-message`;
        messageDiv.id = `message-${messageCount}`;
        
        if (type === 'user') {
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start justify-content-end">
                    <div class="flex-grow-1 text-end me-3">
                        <strong class="d-block mb-1">You</strong>
                        <div class="message-content">${escapeHtml(message)}</div>
                    </div>
                    <div class="feature-icon" style="width: 35px; height: 35px; font-size: 0.9rem;">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="feature-icon me-3" style="width: 35px; height: 35px; font-size: 0.9rem;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="flex-grow-1">
                        <strong class="d-block mb-1">OrganicGuard AI</strong>
                        <div class="message-content">${formatMessage(message)}</div>
                    </div>
                </div>
            `;
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Animate message appearance
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(20px)';
            messageDiv.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 10);
        }, 10);
    }

    function showTypingIndicator() {
        const chatContainer = document.getElementById('chatContainer');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message ai-message';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="feature-icon me-3" style="width: 35px; height: 35px; font-size: 0.9rem;">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        `;
        
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function formatMessage(message) {
        // Convert line breaks to <br> tags
        message = message.replace(/\n/g, '<br>');
        
        // Format numbered lists
        message = message.replace(/(\d+\.\s)/g, '<br><strong>$1</strong>');
        
        // Format bullet points
        message = message.replace(/(\*\s)/g, '<br>â€¢ ');
        
        // Format bold text
        message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        return message;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function clearChat() {
        const chatContainer = document.getElementById('chatContainer');
        // Keep only the welcome message (first child)
        while (chatContainer.children.length > 1) {
            chatContainer.removeChild(chatContainer.lastChild);
        }
        messageCount = 0;
    }

    // Auto-focus on message input
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('messageInput').focus();
    });
</script>

<style>
    .typing-dots {
        display: inline-block;
        position: relative;
        width: 50px;
        height: 20px;
    }

    .typing-dots span {
        position: absolute;
        top: 50%;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #6c757d;
        animation: typing 1.4s infinite ease-in-out;
        transform: translateY(-50%);
    }

    .typing-dots span:nth-child(1) {
        left: 0;
        animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
        left: 12px;
        animation-delay: -0.16s;
    }

    .typing-dots span:nth-child(3) {
        left: 24px;
    }

    @keyframes typing {
        0%, 80%, 100% {
            transform: translateY(-50%) scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
    }

    .message-content {
        line-height: 1.5;
    }

    .chat-message {
        animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}
