{% extends "base.html" %}

{% block title %}Analysis History - OrganicGuard AI{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6">
                    <i class="fas fa-history me-2"></i>Analysis History
                </h1>
                <a href="{{ url_for('analyze') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Analysis
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ analyses|length }}</div>
                <div>Total Analyses</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">
                    {% set unique_pests = analyses|map(attribute=2)|list|unique|list %}
                    {{ unique_pests|length }}
                </div>
                <div>Unique Pests</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">
                    {% set high_confidence = analyses|selectattr(2, 'number')|selectattr(3, 'gt', 80)|list %}
                    {{ high_confidence|length }}
                </div>
                <div>High Confidence</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">
                    {% set this_month = analyses|selectattr(1, 'string')|selectattr(1, 'match', '.*2024-.*')|list %}
                    {{ this_month|length }}
                </div>
                <div>This Month</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="feature-card">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>Filter Results
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="pestFilter" class="form-label">Pest Type</label>
                        <select class="form-select" id="pestFilter" onchange="filterResults()">
                            <option value="">All Pests</option>
                            <option value="Aphids">Aphids</option>
                            <option value="Beetle">Beetles</option>
                            <option value="Whitefly">Whiteflies</option>
                            <option value="Thrips">Thrips</option>
                            <option value="Mites">Mites</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="severityFilter" class="form-label">Severity</label>
                        <select class="form-select" id="severityFilter" onchange="filterResults()">
                            <option value="">All Severities</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="confidenceFilter" class="form-label">Confidence</label>
                        <select class="form-select" id="confidenceFilter" onchange="filterResults()">
                            <option value="">All Confidence</option>
                            <option value="high">High (>80%)</option>
                            <option value="medium">Medium (50-80%)</option>
                            <option value="low">Low (<50%)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchFilter" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" 
                               placeholder="Search analyses..." 
                               onkeyup="filterResults()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    {% if analyses %}
    <div class="row" id="analysisResults">
        {% for analysis in analyses %}
        <div class="col-lg-6 col-xl-4 mb-4 analysis-item" 
             data-pest="{{ analysis[2] or 'Unknown' }}" 
             data-severity="{{ analysis[4] or 'Medium' }}" 
             data-confidence="{{ analysis[3] or 0 }}"
             data-search="{{ (analysis[2] or '') + ' ' + (analysis[4] or '') + ' ' + (analysis[1] or '') }}">
            <div class="analysis-card h-100">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="mb-0">{{ analysis[2] or 'Unknown Pest' }}</h5>
                    <span class="severity-badge severity-{{ (analysis[4] or 'medium').lower() }}">
                        {{ analysis[4] or 'Medium' }}
                    </span>
                </div>

                <!-- Image Preview -->
                {% if analysis[5] %}
                <div class="mb-3">
                    <img src="{{ url_for('static', filename='uploads/' + analysis[5].split('/')[-1]) }}" 
                         alt="Pest analysis" 
                         class="img-fluid rounded"
                         style="max-height: 150px; width: 100%; object-fit: cover;">
                </div>
                {% else %}
                <div class="mb-3 text-center p-3 bg-light rounded">
                    <i class="fas fa-image fa-2x text-muted"></i>
                    <p class="text-muted small mb-0 mt-2">No image available</p>
                </div>
                {% endif %}

                <!-- Details -->
                <div class="mb-3">
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <small class="text-muted d-block">Confidence</small>
                            <div class="d-flex align-items-center">
                                <div class="confidence-bar flex-grow-1 me-2">
                                    <div class="confidence-fill" style="width: {{ analysis[3] or 0 }}%"></div>
                                </div>
                                <strong class="small">{{ "%.1f"|format(analysis[3] or 0) }}%</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Date</small>
                            <strong class="small">
                                {{ analysis[1][:10] if analysis[1] else 'Unknown' }}
                            </strong>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-12">
                            <small class="text-muted d-block">Time</small>
                            <strong class="small">
                                {{ analysis[1][11:19] if analysis[1] and analysis[1]|length > 19 else 'Unknown time' }}
                            </strong>
                        </div>
                    </div>
                </div>

                <!-- Treatment Applied -->
                {% if analysis[6] %}
                <div class="mb-3">
                    <small class="text-muted d-block">Treatment Applied</small>
                    <div class="bg-light p-2 rounded">
                        <small>{{ analysis[6] }}</small>
                    </div>
                </div>
                {% endif %}

                <!-- Notes -->
                {% if analysis[7] %}
                <div class="mb-3">
                    <small class="text-muted d-block">Notes</small>
                    <div class="bg-light p-2 rounded">
                        <small>{{ analysis[7] }}</small>
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="mt-auto">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm flex-grow-1" 
                                onclick="viewDetails({{ analysis[0] }})">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                        <button class="btn btn-outline-success btn-sm" 
                                onclick="addTreatment({{ analysis[0] }})">
                            <i class="fas fa-plus me-1"></i>Treatment
                        </button>
                        <button class="btn btn-outline-info btn-sm" 
                                onclick="addNote({{ analysis[0] }})">
                            <i class="fas fa-sticky-note me-1"></i>Note
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Results Message -->
    <div class="row d-none" id="noResults">
        <div class="col-12">
            <div class="feature-card text-center">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No analyses found</h4>
                <p class="text-muted">Try adjusting your filters or search terms.</p>
                <a href="{{ url_for('analyze') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create New Analysis
                </a>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="feature-card text-center">
                <i class="fas fa-clipboard-list fa-4x text-muted mb-4"></i>
                <h2>No Analysis History</h2>
                <p class="text-muted mb-4">
                    You haven't performed any pest analyses yet. Start by uploading an image for AI identification.
                </p>
                <a href="{{ url_for('analyze') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-camera me-2"></i>Start First Analysis
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Export Options -->
    {% if analyses %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="feature-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2">
                            <i class="fas fa-download me-2"></i>Export Data
                        </h5>
                        <p class="text-muted mb-md-0">
                            Export your analysis history for record keeping or external analysis.
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="d-flex gap-2 justify-content-md-end">
                            <button class="btn btn-outline-primary" onclick="exportCSV()">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportJSON()">
                                <i class="fas fa-file-code me-1"></i>JSON
                            </button>
                            <button class="btn btn-outline-info" onclick="printHistory()">
                                <i class="fas fa-print me-1"></i>Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Treatment Modal -->
<div class="modal fade" id="treatmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-leaf me-2"></i>Add Treatment Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="treatmentForm">
                    <input type="hidden" id="treatmentAnalysisId">
                    <div class="mb-3">
                        <label for="treatmentMethod" class="form-label">Treatment Method</label>
                        <select class="form-select" id="treatmentMethod">
                            <option value="">Select treatment...</option>
                            <option value="Insecticidal Soap">Insecticidal Soap</option>
                            <option value="Neem Oil">Neem Oil</option>
                            <option value="Beneficial Insects">Beneficial Insects</option>
                            <option value="Diatomaceous Earth">Diatomaceous Earth</option>
                            <option value="Horticultural Oil">Horticultural Oil</option>
                            <option value="Hand Picking">Hand Picking</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="treatmentNotes" class="form-label">Application Notes</label>
                        <textarea class="form-control" id="treatmentNotes" rows="3" 
                                  placeholder="Describe application method, timing, weather conditions, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveTreatment()">
                    <i class="fas fa-save me-2"></i>Save Treatment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sticky-note me-2"></i>Add Note
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteAnalysisId">
                    <div class="mb-3">
                        <label for="userNote" class="form-label">Your Notes</label>
                        <textarea class="form-control" id="userNote" rows="4" 
                                  placeholder="Add observations, results, follow-up actions, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">
                    <i class="fas fa-save me-2"></i>Save Note
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function filterResults() {
        const pestFilter = document.getElementById('pestFilter').value.toLowerCase();
        const severityFilter = document.getElementById('severityFilter').value.toLowerCase();
        const confidenceFilter = document.getElementById('confidenceFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
        
        const analysisItems = document.querySelectorAll('.analysis-item');
        let visibleCount = 0;
        
        analysisItems.forEach(function(item) {
            let show = true;
            
            // Pest filter
            if (pestFilter && !item.dataset.pest.toLowerCase().includes(pestFilter)) {
                show = false;
            }
            
            // Severity filter
            if (severityFilter && !item.dataset.severity.toLowerCase().includes(severityFilter)) {
                show = false;
            }
            
            // Confidence filter
            if (confidenceFilter) {
                const confidence = parseFloat(item.dataset.confidence) || 0;
                if (confidenceFilter === 'high' && confidence <= 80) show = false;
                if (confidenceFilter === 'medium' && (confidence < 50 || confidence > 80)) show = false;
                if (confidenceFilter === 'low' && confidence >= 50) show = false;
            }
            
            // Search filter
            if (searchFilter && !item.dataset.search.toLowerCase().includes(searchFilter)) {
                show = false;
            }
            
            item.style.display = show ? 'block' : 'none';
            if (show) visibleCount++;
        });
        
        // Show/hide no results message
        const noResults = document.getElementById('noResults');
        if (visibleCount === 0) {
            noResults.classList.remove('d-none');
        } else {
            noResults.classList.add('d-none');
        }
    }

    function viewDetails(analysisId) {
        // In a real implementation, this would navigate to a detailed view
        alert(`Viewing details for analysis ID: ${analysisId}`);
    }

    function addTreatment(analysisId) {
        document.getElementById('treatmentAnalysisId').value = analysisId;
        const modal = new bootstrap.Modal(document.getElementById('treatmentModal'));
        modal.show();
    }

    function addNote(analysisId) {
        document.getElementById('noteAnalysisId').value = analysisId;
        const modal = new bootstrap.Modal(document.getElementById('noteModal'));
        modal.show();
    }

    function saveTreatment() {
        const analysisId = document.getElementById('treatmentAnalysisId').value;
        const method = document.getElementById('treatmentMethod').value;
        const notes = document.getElementById('treatmentNotes').value;
        
        if (!method) {
            alert('Please select a treatment method');
            return;
        }
        
        // In a real implementation, this would save to the database
        alert(`Treatment recorded for analysis ${analysisId}: ${method}`);
        
        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('treatmentModal')).hide();
        document.getElementById('treatmentForm').reset();
    }

    function saveNote() {
        const analysisId = document.getElementById('noteAnalysisId').value;
        const note = document.getElementById('userNote').value;
        
        if (!note.trim()) {
            alert('Please enter a note');
            return;
        }
        
        // In a real implementation, this would save to the database
        alert(`Note saved for analysis ${analysisId}`);
        
        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
        document.getElementById('noteForm').reset();
    }

    function exportCSV() {
        // In a real implementation, this would generate and download CSV
        alert('CSV export functionality would be implemented here');
    }

    function exportJSON() {
        // In a real implementation, this would generate and download JSON
        alert('JSON export functionality would be implemented here');
    }

    function printHistory() {
        window.print();
    }

    // Animate confidence bars on page load
    document.addEventListener('DOMContentLoaded', function() {
        const confidenceBars = document.querySelectorAll('.confidence-fill');
        confidenceBars.forEach(function(bar, index) {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(function() {
                bar.style.width = width;
            }, 200 + (index * 50));
        });
    });
</script>
{% endblock %}
