"""
LM Studio LLM Service for OrganicGuard AI
Provides advanced AI chat functionality using LM Studio's local models
"""

import requests
import json
import logging
from typing import Optional, Dict, Any

logger = logging.getLogger(__name__)

class OrganicGuardLLM:
    """LM Studio LLM service for organic pest management conversations"""
    
    def __init__(self, base_url: str = "http://localhost:1234", model_name: str = None):
        """
        Initialize the LM Studio LLM service
        
        Args:
            base_url: LM Studio server URL (default: http://localhost:1234)
            model_name: Specific model to use (optional, uses default loaded model)
        """
        self.base_url = base_url.rstrip('/')
        self.model_name = model_name
        self.available = False
        self.timeout = 60   
        
        # Test connection on initialization
        self._test_connection()
        
        # System prompt for organic pest management context
        self.system_prompt = """You are OrganicGuard AI, an expert organic pest management assistant. You specialize in:

1. Identifying pests from descriptions
2. Recommending organic, eco-friendly treatment methods
3. Providing IPM (Integrated Pest Management) strategies
4. Explaining prevention techniques
5. Offering cost-effective organic solutions
6. Ensuring treatments are safe for beneficial insects and the environment

Guidelines:
- Always prioritize organic, chemical-free solutions
- Consider beneficial insects and pollinators
- Provide practical, actionable advice
- Include timing and application instructions
- Mention cost considerations when relevant
- Keep responses focused, helpful and summarised
- If unsure, recommend consulting local extension services

Respond in a helpful, knowledgeable tone suitable for both hobbyist gardeners and professional organic farmers."""

    def _test_connection(self) -> bool:
        """Test connection to LM Studio server"""
        try:
            # First try to connect to the base URL
            response = requests.get(
                f"{self.base_url}/v1/models",
                timeout=5
            )
            if response.status_code == 200:
                self.available = True
                models = response.json()
                model_count = len(models.get('data', []))
                logger.info(f"‚úÖ Connected to LM Studio. Available models: {model_count}")
                
                if model_count == 0:
                    logger.warning("‚ö†Ô∏è LM Studio connected but no models loaded!")
                    logger.warning("   Please load a model in LM Studio to use chat features")
                
                return True
            elif response.status_code == 404:
                logger.warning(f"‚ö†Ô∏è LM Studio API not found (404). Check if:")
                logger.warning(f"   1. LM Studio is running on {self.base_url}")
                logger.warning(f"   2. The local server is enabled in LM Studio")
                logger.warning(f"   3. Try different port if not using default 1234")
                return False
            else:
                logger.warning(f"‚ö†Ô∏è LM Studio responded with status {response.status_code}")
                return False
                
        except requests.exceptions.ConnectionError:
            logger.warning(f"‚ö†Ô∏è Cannot connect to LM Studio at {self.base_url}")
            logger.warning("   Make sure LM Studio is running and local server is enabled")
            self.available = False
            return False
        except requests.exceptions.RequestException as e:
            logger.warning(f"‚ö†Ô∏è Connection error: {e}")
            self.available = False
            return False

    def generate_response(self, user_message: str, conversation_history: Optional[list] = None) -> str:
        """
        Generate response using LM Studio model
        
        Args:
            user_message: User's question or message
            conversation_history: Previous conversation context (optional)
            
        Returns:
            AI-generated response string
        """
        if not self.available:
            logger.warning("LM Studio not available, using fallback response")
            return self._generate_fallback_response(user_message)
        
        try:
            # Prepare messages for the API
            messages = [
                {"role": "system", "content": self.system_prompt}
            ]
            
            # Add conversation history if provided
            if conversation_history:
                messages.extend(conversation_history)
            
            # Add current user message
            messages.append({"role": "user", "content": user_message})
            
            # Prepare request payload
            payload = {
                "model": self.model_name or "local-model",
                "messages": messages,
                "temperature": 0.7,
                "max_tokens": 500,
                "stream": False,
                "stop": None
            }
            
            # Make request to LM Studio
            response = requests.post(
                f"{self.base_url}/v1/chat/completions",
                json=payload,
                timeout=self.timeout,
                headers={"Content-Type": "application/json"}
            )
            
            if response.status_code == 200:
                data = response.json()
                
                if 'choices' in data and len(data['choices']) > 0:
                    ai_response = data['choices'][0]['message']['content'].strip()
                    logger.info(f"‚úÖ LM Studio response generated ({len(ai_response)} chars)")
                    return ai_response
                else:
                    logger.error("‚ùå Invalid response format from LM Studio")
                    return self._generate_fallback_response(user_message)
            else:
                logger.error(f"‚ùå LM Studio API error: {response.status_code} - {response.text}")
                if response.status_code == 404:
                    logger.error("üö® 404 Error: LM Studio server not found. Check if:")
                    logger.error("   1. LM Studio is running")
                    logger.error("   2. Server is on http://localhost:1234")
                    logger.error("   3. A model is loaded in LM Studio")
                return self._generate_fallback_response(user_message)
                
        except requests.exceptions.Timeout:
            logger.error("‚ùå LM Studio request timed out")
            return "I'm experiencing some delays. Here's a quick tip: For most organic pest issues, neem oil and insecticidal soap are excellent starting points. What specific pest are you dealing with?"
        
        except requests.exceptions.RequestException as e:
            logger.error(f"‚ùå LM Studio request failed: {e}")
            return self._generate_fallback_response(user_message)
        
        except Exception as e:
            logger.error(f"‚ùå Unexpected error in LM Studio service: {e}")
            return self._generate_fallback_response(user_message)

    def _generate_fallback_response(self, user_message: str) -> str:
        """
        Generate specialized fallback responses when LM Studio is unavailable
        
        Args:
            user_message: User's message to respond to
            
        Returns:
            Specialized organic pest management response
        """
        message = user_message.lower()
        
        # Pest-specific responses
        if any(word in message for word in ['aphid', 'aphids']):
            return """üêõ **Aphid Control (Organic Methods)**

**Immediate Actions:**
‚Ä¢ Insecticidal soap: 2 tbsp mild soap per gallon water
‚Ä¢ Neem oil spray: 2-4 tbsp per gallon, apply early morning/evening
‚Ä¢ Strong water spray to dislodge colonies

**Biological Control:**
‚Ä¢ Release ladybugs (1,500 per small garden)
‚Ä¢ Attract lacewings with diverse flowering plants
‚Ä¢ Plant companion herbs: basil, catnip, garlic

**Prevention:**
‚Ä¢ Avoid over-fertilizing with nitrogen
‚Ä¢ Use reflective mulches to confuse aphids
‚Ä¢ Regular monitoring of undersides of leaves

üí∞ **Cost**: $15-25 for small garden treatment
‚è∞ **Best timing**: Early morning application, reapply weekly"""

        elif any(word in message for word in ['spider', 'mite', 'mites']):
            return """üï∑Ô∏è **Spider Mite Management (Organic)**

**Symptoms**: Fine webbing, stippled leaves, bronze coloring

**Organic Treatments:**
‚Ä¢ Predatory mites (Phytoseiulus persimilis)
‚Ä¢ Insecticidal soap + neem oil combination
‚Ä¢ Increase humidity around plants
‚Ä¢ Strong water sprays 3x weekly

**Cultural Controls:**
‚Ä¢ Avoid dusty conditions (mites thrive in dust)
‚Ä¢ Proper plant spacing for air circulation
‚Ä¢ Remove heavily infested leaves

**Prevention:**
‚Ä¢ Regular misting in dry conditions
‚Ä¢ Companion planting with aromatic herbs
‚Ä¢ Beneficial insect habitat (diverse plantings)

‚ö†Ô∏è **Important**: Spider mites reproduce rapidly in hot, dry conditions"""

        elif any(word in message for word in ['slug', 'snail', 'slugs', 'snails']):
            return """üêå **Slug & Snail Control (Organic)**

**Physical Barriers:**
‚Ä¢ Copper tape around containers/beds
‚Ä¢ Diatomaceous earth rings (reapply after rain)
‚Ä¢ Sharp gravel or crushed eggshells

**Organic Baits:**
‚Ä¢ Iron phosphate pellets (pet/wildlife safe)
‚Ä¢ Beer traps (shallow dishes, replace every 2-3 days)
‚Ä¢ Grapefruit rinds as traps (collect daily)

**Habitat Modification:**
‚Ä¢ Remove hiding spots (boards, debris, thick mulch)
‚Ä¢ Water in morning only (not evening)
‚Ä¢ Create dry zones around sensitive plants

**Natural Predators:**
‚Ä¢ Encourage birds with bird baths/houses
‚Ä¢ Ground beetles (provide log shelters)
‚Ä¢ Garter snakes (if climate appropriate)

üåô **Best collection time**: Early morning or with flashlight at night"""

        elif any(word in message for word in ['whitefly', 'whiteflies']):
            return """ü¶ü **Whitefly Management (Organic)**

**Immediate Control:**
‚Ä¢ Yellow sticky traps (replace weekly)
‚Ä¢ Insecticidal soap spray (2-3x weekly)
‚Ä¢ Neem oil (systemic action, 7-14 day intervals)

**Biological Control:**
‚Ä¢ Encarsia wasps (parasitize whitefly nymphs)
‚Ä¢ Ladybugs for adult feeding
‚Ä¢ Reflective mulches to confuse adults

**Cultural Practices:**
‚Ä¢ Remove yellowing leaves promptly
‚Ä¢ Avoid over-fertilizing (makes plants attractive)
‚Ä¢ Companion planting: marigolds, nasturtiums
‚Ä¢ Proper plant spacing for air circulation

**Monitoring:**
‚Ä¢ Check undersides of leaves weekly
‚Ä¢ Shake plants gently - adults will fly if present
‚Ä¢ Yellow sticky trap counts for population tracking

‚ö†Ô∏è **Key**: Whiteflies have rapid reproduction cycles - consistency is crucial"""

        elif any(word in message for word in ['caterpillar', 'catterpillar', 'worm', 'hornworm']):
            return """üêõ **Caterpillar Control (Organic Methods)**

**Bt Spray (Bacillus thuringiensis):**
‚Ä¢ Apply in evening (UV sensitive)
‚Ä¢ Target young caterpillars (more effective)
‚Ä¢ Reapply after rain, every 7-10 days
‚Ä¢ Safe for humans, pets, beneficial insects

**Physical Removal:**
‚Ä¢ Hand-picking (early morning most effective)
‚Ä¢ Look for frass (droppings) to locate them
‚Ä¢ Check undersides of leaves regularly
‚Ä¢ Use flashlight for night inspection

**Natural Predators:**
‚Ä¢ Encourage birds with houses/water
‚Ä¢ Beneficial wasps (plant diverse flowers)
‚Ä¢ Spiders and ground beetles
‚Ä¢ Chickens if garden setup allows

**Prevention:**
‚Ä¢ Row covers during egg-laying periods
‚Ä¢ Companion planting: dill, fennel (attract beneficial wasps)
‚Ä¢ Regular garden cleanup
‚Ä¢ Crop rotation annually

üîç **Detection tip**: Look for chewed leaf edges and dark frass on leaves"""

        elif any(word in message for word in ['scale', 'scales']):
            return """üõ°Ô∏è **Scale Insect Control (Organic)**

**Oil Treatments:**
‚Ä¢ Horticultural oil (2-4 tbsp per gallon)
‚Ä¢ Neem oil (systemic action)
‚Ä¢ Apply during cooler parts of day
‚Ä¢ Ensure complete coverage of stems/leaves

**Physical Removal:**
‚Ä¢ Soft brush + soapy water for light infestations
‚Ä¢ Fingernail or soft scraper for individuals
‚Ä¢ Rubbing alcohol on cotton swab for spot treatment

**Systemic Approach:**
‚Ä¢ Beneficial insects: ladybugs, lacewings
‚Ä¢ Parasitic wasps (Aphytis, Encarsia species)
‚Ä¢ Improve plant health (proper fertilization/watering)

**Prevention:**
‚Ä¢ Quarantine new plants 2-3 weeks
‚Ä¢ Regular inspection (scales are sneaky!)
‚Ä¢ Avoid over-fertilizing with nitrogen
‚Ä¢ Proper plant spacing for air circulation

‚è∞ **Best treatment time**: During crawler stage (mobile phase)"""

        elif any(word in message for word in ['thrips']):
            return """‚ö° **Thrips Management (Organic)**

**Identification:**
‚Ä¢ Tiny (1-2mm), slender insects
‚Ä¢ Silver/bronze leaf streaks
‚Ä¢ Black specks (excrement) on leaves
‚Ä¢ Flowers may be deformed/discolored

**Organic Controls:**
‚Ä¢ Blue sticky traps (thrips prefer blue over yellow)
‚Ä¢ Insecticidal soap + neem oil combination
‚Ä¢ Predatory mites (Amblyseius species)
‚Ä¢ Beneficial nematodes for soil-pupating species

**Cultural Practices:**
‚Ä¢ Remove weeds (alternate hosts)
‚Ä¢ Reflective mulches deter adults
‚Ä¢ Proper irrigation (thrips prefer stressed plants)
‚Ä¢ Remove spent flowers/damaged leaves

**Biological Control:**
‚Ä¢ Minute pirate bugs (Orius species)
‚Ä¢ Lacewing larvae
‚Ä¢ Predatory thrips species
‚Ä¢ Encourage with diverse flowering plants

üí° **Pro tip**: Thrips are most active in warm, dry conditions"""

        elif any(word in message for word in ['fungus', 'mold', 'mildew', 'blight']):
            return """üçÑ **Organic Fungal Disease Management**

**Preventive Sprays:**
‚Ä¢ Baking soda spray: 1 tsp per quart water + drop of soap
‚Ä¢ Milk spray: 1 part milk to 9 parts water
‚Ä¢ Compost tea: Weekly application
‚Ä¢ Neem oil: Also prevents fungal issues

**Cultural Controls:**
‚Ä¢ Improve air circulation (proper spacing)
‚Ä¢ Water at soil level (avoid wetting leaves)
‚Ä¢ Morning watering (leaves dry quickly)
‚Ä¢ Remove infected plant material immediately

**Soil Health:**
‚Ä¢ Add compost regularly (beneficial microorganisms)
‚Ä¢ Ensure proper drainage
‚Ä¢ Mulch to prevent soil splash onto leaves
‚Ä¢ Crop rotation to break disease cycles

**Resistant Varieties:**
‚Ä¢ Choose disease-resistant cultivars when possible
‚Ä¢ Native plants often have better natural resistance
‚Ä¢ Proper plant selection for your climate

‚ö†Ô∏è **Remember**: Prevention is much easier than treatment for fungal issues"""

        # General responses
        elif any(word in message for word in ['organic', 'natural', 'safe']):
            return """üå± **Core Organic Pest Management Principles**

**The Organic Toolbox:**
1. **Biological Control**: Beneficial insects, parasites, predators
2. **Cultural Practices**: Crop rotation, companion planting, sanitation
3. **Physical Barriers**: Row covers, traps, barriers
4. **Organic Sprays**: Neem oil, insecticidal soap, botanical oils
5. **Soil Health**: Compost, beneficial microorganisms

**Safety First:**
‚Ä¢ Always read labels, even on organic products
‚Ä¢ Apply treatments during cooler parts of day
‚Ä¢ Avoid spraying during peak pollinator activity
‚Ä¢ Wear appropriate protective equipment

**Cost-Effective Strategies:**
‚Ä¢ Prevention costs less than treatment
‚Ä¢ Make your own insecticidal soap
‚Ä¢ Encourage beneficial insects (free labor!)
‚Ä¢ Build healthy soil for natural plant resistance

**Certification Compatible:**
Most methods mentioned are approved for organic certification, but always verify with your certifying body if commercial."""

        elif any(word in message for word in ['beneficial', 'insects', 'predator', 'parasites']):
            return """üêû **Beneficial Insects for Organic Pest Control**

**Key Beneficial Species:**
‚Ä¢ **Ladybugs**: Aphids, mites, small caterpillars
‚Ä¢ **Lacewings**: Aphids, thrips, whiteflies, mites
‚Ä¢ **Parasitic wasps**: Various pest species (host-specific)
‚Ä¢ **Predatory mites**: Spider mites, thrips
‚Ä¢ **Ground beetles**: Slugs, caterpillars, soil pests

**How to Attract Beneficials:**
‚Ä¢ Diverse flowering plants (succession blooming)
‚Ä¢ Native plants and wildflower areas
‚Ä¢ Shallow water sources
‚Ä¢ Shelter options (logs, stones, diverse plantings)
‚Ä¢ Reduce pesticide use (even organic ones when beneficial insects present)

**Commercial Releases:**
‚Ä¢ Best for greenhouse/protected environments
‚Ä¢ Release when pest populations are moderate
‚Ä¢ Follow supplier instructions for timing/numbers
‚Ä¢ Provide food sources (flowers) and shelter

**Plants That Attract Beneficials:**
‚Ä¢ Yarrow, dill, fennel, sweet alyssum
‚Ä¢ Marigolds, nasturtiums, sunflowers
‚Ä¢ Native wildflowers and herbs

üåº **Pro tip**: A diverse ecosystem naturally balances pest and beneficial populations"""

        elif any(word in message for word in ['cost', 'budget', 'expensive', 'cheap']):
            return """üí∞ **Budget-Friendly Organic Pest Management**

**DIY Solutions (Under $10):**
‚Ä¢ Insecticidal soap: 2 tbsp dish soap + 1 gallon water
‚Ä¢ Garlic/pepper spray: Blend + strain + spray
‚Ä¢ Beer traps for slugs: Use shallow containers
‚Ä¢ Companion planting: Seeds cost less than treatments

**Mid-Range Options ($10-50):**
‚Ä¢ Neem oil concentrate (multiple applications)
‚Ä¢ Beneficial insect releases for small gardens
‚Ä¢ Row covers (reusable for several seasons)
‚Ä¢ Organic certified products

**Investment Options ($50+):**
‚Ä¢ Predatory mite releases for larger areas
‚Ä¢ Quality organic fertilizers (long-term plant health)
‚Ä¢ Copper barriers for permanent slug control
‚Ä¢ Professional beneficial insect habitat plants

**Money-Saving Tips:**
‚Ä¢ Prevention always costs less than treatment
‚Ä¢ Buy neem oil concentrate vs. ready-to-use
‚Ä¢ Share beneficial insect orders with neighbors
‚Ä¢ Start with cheapest effective option first

üìä **ROI Focus**: Healthy soil + diverse plantings = fewer pest problems long-term"""

        elif any(word in message for word in ['timing', 'when', 'schedule']):
            return """‚è∞ **Optimal Timing for Organic Treatments**

**Daily Timing:**
‚Ä¢ **Early morning (6-8 AM)**: Cool temperatures, calm winds
‚Ä¢ **Evening (6-8 PM)**: After pollinators are less active
‚Ä¢ **Avoid midday**: Heat stress on plants, active beneficial insects

**Seasonal Considerations:**
‚Ä¢ **Spring**: Preventive treatments, beneficial releases
‚Ä¢ **Summer**: Regular monitoring, targeted treatments
‚Ä¢ **Fall**: Garden cleanup, soil preparation
‚Ä¢ **Winter**: Planning, equipment maintenance

**Weather Factors:**
‚Ä¢ No rain expected for 4-6 hours minimum
‚Ä¢ Light winds (under 10 mph for spray applications)
‚Ä¢ Temperature between 65-85¬∞F for most treatments
‚Ä¢ Higher humidity helps some beneficial microorganisms

**Pest Life Cycle Timing:**
‚Ä¢ Target vulnerable stages (young caterpillars, crawler scales)
‚Ä¢ Monitor for peak activity periods
‚Ä¢ Coordinate treatments with natural enemy releases

**Treatment Schedules:**
‚Ä¢ Weekly monitoring walks
‚Ä¢ Bi-weekly preventive treatments if needed
‚Ä¢ Monthly soil health assessments

üå°Ô∏è **Weather apps** are your friend for timing applications!"""

        else:
            return """üåø **OrganicGuard AI - Your Organic Pest Management Assistant**

I'm here to help with organic, eco-friendly pest management! I can assist you with:

**üîç Pest Identification & Treatment:**
‚Ä¢ Upload photos for AI identification
‚Ä¢ Specific organic treatment recommendations
‚Ä¢ Safe application methods and timing

**üå± Sustainable Approaches:**
‚Ä¢ Integrated Pest Management (IPM) strategies
‚Ä¢ Beneficial insect attraction and conservation
‚Ä¢ Soil health for natural plant resistance

**üí° Practical Guidance:**
‚Ä¢ Cost-effective solutions for any budget
‚Ä¢ Prevention strategies (cheaper than treatment!)
‚Ä¢ Organic certification-compatible methods

**Popular Topics:**
‚Ä¢ "How do I control aphids organically?"
‚Ä¢ "What are safe treatments for caterpillars?"
‚Ä¢ "How can I attract beneficial insects?"
‚Ä¢ "Organic solutions for slugs and snails?"
‚Ä¢ "Budget-friendly pest management tips?"

**üì∏ For best results**: Upload a clear photo of the pest or damage, or describe your specific situation!

What pest challenge can I help you solve today?"""

    def set_custom_system_prompt(self, prompt: str):
        """Set a custom system prompt for specialized conversations"""
        self.system_prompt = prompt
        logger.info("Custom system prompt set for LM Studio service")

    def get_available_models(self) -> list:
        """Get list of available models from LM Studio"""
        if not self.available:
            return []
        
        try:
            response = requests.get(f"{self.base_url}/v1/models", timeout=5)
            if response.status_code == 200:
                data = response.json()
                return [model['id'] for model in data.get('data', [])]
            return []
        except Exception as e:
            logger.error(f"Failed to get available models: {e}")
            return []

    def health_check(self) -> Dict[str, Any]:
        """Perform health check and return status information"""
        return {
            'available': self.available,
            'base_url': self.base_url,
            'model_name': self.model_name,
            'models_available': len(self.get_available_models()),
            'connection_test': self._test_connection()
        }
